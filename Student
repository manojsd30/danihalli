#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#define NAME_LEN 50

typedef struct {
    char name[NAME_LEN];
    int reg_no;
    float marks[3];
    float average_marks;
} Student;

void read_students(Student *students, int n) {
    for (int i = 0; i < n; i++) {
        printf("\n--- Student %d ---\n", i + 1);
        printf("Name: ");
        getchar();
        fgets(students[i].name, NAME_LEN, stdin);
        students[i].name[strcspn(students[i].name, "\n")] = '\0';
        printf("Reg No: ");
        scanf("%d", &students[i].reg_no);
        for (int j = 0; j < 3; j++) {
            printf("Mark %d: ", j + 1);
            scanf("%f", &students[i].marks[j]);
        }
        students[i].average_marks = 0.0;
    }
}

void display_students(Student *students, int n) {
    if (n == 0) {
        printf("\nNo students to display!\n");
        return;
    }
    for (int i = 0; i < n; i++) {
        printf("\nName: %s\n", students[i].name);
        printf("Reg No: %d\n", students[i].reg_no);
        printf("Marks: %.2f, %.2f, %.2f\n", students[i].marks[0], students[i].marks[1], students[i].marks[2]);
        if (students[i].average_marks > 0)
            printf("Average of best two: %.2f\n", students[i].average_marks);
        else
            printf("Average of best two: Not calculated\n");
    }
}

void calc_average(Student *students, int n) {
    for (int i = 0; i < n; i++) {
        float a = students[i].marks[0];
        float b = students[i].marks[1];
        float c = students[i].marks[2];
        float smallest = a;
        if (b < smallest) smallest = b;
        if (c < smallest) smallest = c;
        float best_two_sum = a + b + c - smallest;
        students[i].average_marks = best_two_sum / 2.0;
    }
    printf("\nAverage of best two marks calculated!\n");
}

int main() {
    Student *students = NULL;
    int n = 0, choice;

    while (1) {
        printf("\n===== MENU =====\n");
        printf("1. Read Students\n");
        printf("2. Display Students\n");
        printf("3. Calculate Average (Best 2)\n");
        printf("4. Add More Students\n");
        printf("5. Exit\n");
        printf("Enter your choice: ");
        scanf("%d", &choice);

        switch (choice) {
            case 1: {
                printf("How many students? ");
                scanf("%d", &n);
                free(students);
                students = (Student*) calloc(n, sizeof(Student));
                read_students(students, n);
                break;
            }
            case 2:
                display_students(students, n);
                break;
            case 3:
                if (students == NULL)
                    printf("No students! Enter data first.\n");
                else
                    calc_average(students, n);
                break;
            case 4: {
                if (students == NULL) {
                    printf("No students yet! Use option 1 first.\n");
                } else {
                    int extra;
                    printf("How many more students to add? ");
                    scanf("%d", &extra);
                    students = (Student*) realloc(students, (n + extra) * sizeof(Student));
                    read_students(students + n, extra);
                    n += extra;
                }
                break;
            }
            case 5:
                free(students);
                printf("Exiting...\n");
                return 0;
            default:
                printf("Invalid choice! Try again.\n");
        }
    }
}
